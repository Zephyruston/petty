# 产品需求文档 (PRD): Petty - 终端电子宠物

## 1. 项目概述

### 1.1. 项目名称

Petty (或 Termogotchi)

### 1.2. 项目愿景

为开发者和终端爱好者提供一个有趣、怀旧且富有情感连接的互动体验。通过在命令行界面中模拟经典的电子宠物（Tamagotchi），我们旨在创造一个轻量级、低干扰的"数字伴侣"，让用户在紧张的编码和工作间隙找到一丝乐趣和慰藉。

### 1.3. 目标与成功指标

- **核心目标**: 开发一个功能完整的终端电子宠物，实现核心的互动、成长和状态持久化功能。
- **成功指标**:
  - **用户参与度**: 每日活跃用户 (DAU) 达到 100 人。
  - **用户留存**: 30% 的用户在首次使用后，一周内至少重新打开一次应用。
  - **功能完整性**: 100% 实现下方定义的核心功能。
  - **社区反馈**: 在 GitHub 或相关论坛上获得积极的评价和功能建议。

## 2. 目标用户与用户画像

### 2.1. 目标用户

- **软件开发者**: 长时间使用终端，喜欢尝试新奇的 CLI 工具。
- **终端爱好者/Linux & macOS 用户**: 对命令行界面有浓厚兴趣，追求个性化和趣味性。
- **复古游戏玩家**: 怀念 Tamagotchi 等经典养成游戏，希望在现代设备上重温类似体验。

### 2.2. 用户画像 (Persona)

- **姓名**: Alex
- **职业**: 后端工程师
- **背景**: 每天超过 8 小时面对黑色的终端窗口，编写代码、调试程序。他喜欢探索能提升效率或带来乐趣的 CLI 工具。
- **痛点/需求**:
  - 长时间工作感到枯燥，希望终端不只是一个冷冰冰的工具。
  - 怀念小时候玩电子宠物的简单快乐。
  - 希望有一个轻量级的应用，不会干扰他的主要工作流程。
- **使用场景**: 在编译代码的间隙，或者喝咖啡休息时，打开终端，看一眼他的电子宠物，喂喂食、陪它玩一下，放松心情。

## 3. 功能需求

### 3.1. 核心功能 (MVP)

| 功能模块         | 用户故事                                                                                     | 功能描述                                                                                                                                                                                    | 优先级 | 完成状态  | 备注                                               |
| :--------------- | :------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :----- | :-------- | :------------------------------------------------- |
| **宠物生命周期** | 作为一个用户，我希望我的宠物有自己的生命状态，会成长、生病，甚至死亡或离开，这样才感觉真实。 | - 宠物具有年龄、健康值、饥饿度、清洁度、心情等核心属性。<br>- 状态会随时间自动变化（如饥饿度增加）。<br>- 宠物会根据年龄和状态改变其 ASCII Art 外观。                                       | **高** | ✅ 已完成 | 功能完整。外观会根据睡眠、心情、饥饿和清洁度变化。 |
| **基本互动**     | 作为一个用户，我希望能与我的宠物互动，比如喂食、洗澡、陪它玩。                               | - **喂食**: 降低饥饿度，可能增加健康值。<br>- **洗澡**: 提升清洁度。<br>- **玩耍**: 提升心情，但会消耗体力。<br>- **睡觉**: 恢复体力。                                                      | **高** | ✅ 已完成 | 功能完整。                                         |
| **UI 界面**      | 作为一个用户，我希望有一个清晰的界面，能直观地看到我的宠物和它的状态。                       | - 使用 `ratatui` 构建 TUI。<br>- 界面分为左右两栏：<br> - **左栏**: 显示宠物的 ASCII Art。<br> - **右栏**: 显示宠物的各项状态（名称、年龄、健康、心情等）。<br>- 底部显示可操作的命令提示。 | **高** | ✅ 已完成 | 功能完整，已包含按键提示。                         |
| **状态持久化**   | 作为一个用户，我希望我关闭终端后，宠物的状态能被保存，下次打开可以继续。                     | - 使用 `serde_json` 将宠物的状态序列化为 JSON 格式。<br>- 程序启动时，从本地文件 (`~/.petty/state.json`) 读取状态。<br>- 程序退出或定期保存状态到该文件。                                   | **高** | ✅ 已完成 | 功能完整。                                         |

### 3.2. 扩展功能 (彩蛋)

| 功能模块       | 用户故事                                                                 | 功能描述                                                                                                                         | 优先级 | 完成状态  | 备注       |
| :------------- | :----------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------- | :----- | :-------- | :--------- |
| **遗弃机制**   | 作为一个（不负责任的）用户，我想知道如果我长时间不理我的宠物会发生什么。 | - 如果用户连续 3 天未启动应用，宠物会"离家出走"或"死亡"。<br>- 在状态文件中留下一段"遗言"信息。                                  | **中** | ✅ 已完成 | 功能完整。 |
| **开发者模式** | 作为一个开发者，我希望能有一个调试模式来快速测试宠物的不同状态。         | - 输入特定命令（如 `debug`）进入开发者模式。<br>- 在此模式下，宠物会显示一些"第四面墙"的吐槽文本，例如："别再戳我了，我在休假！" | **低** | ✅ 已完成 | 功能完整。 |

### 3.3. 高级功能

| 功能模块         | 用户故事                                                       | 功能描述                                                                                                 | 优先级 | 完成状态  | 备注       |
| :--------------- | :------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------- | :----- | :-------- | :--------- |
| **后台挂起支持** | 作为一个用户，我希望能够在不退出程序的情况下将程序挂起到后台。 | - 支持 Ctrl+Z 将程序挂起到后台<br>- 支持使用 `fg` 命令恢复程序<br>- 即使在后台状态，游戏时间也会继续流逝 | **中** | ✅ 已完成 | 功能完整。 |

## 4. 非功能性需求

| 类别       | 需求描述                                                                                                                          |
| :--------- | :-------------------------------------------------------------------------------------------------------------------------------- |
| **性能**   | - CPU 和内存占用率低，不能影响用户的正常工作。<br>- 启动时间应小于 2 秒。                                                         |
| **兼容性** | - 应在主流的 Linux 发行版和 macOS 上正常运行。<br>- 终端模拟器兼容性：支持常见的终端如 Alacritty, Kitty, iTerm2, GNOME Terminal。 |
| **可用性** | - 命令简单直观，有清晰的帮助文档。<br>- UI 布局清晰，信息一目了然。                                                               |
| **安全性** | - 状态文件应保存在用户主目录下，避免权限问题。<br>- 不会连接任何网络服务，所有操作均在本地完成。                                  |

## 5. 技术规格

- **编程语言**: Rust (Edition 2024)
- **核心库**:
  - `ratatui`: 用于构建终端用户界面。
  - `tokio`: 用于处理异步任务和时间流逝（定时器）。
  - `serde` / `serde_json`: 用于状态的序列化和反序列化。
  - `crossterm`: 用于处理终端事件和控制。
- **项目结构**:
  - `src/main.rs`: 程序主入口。
  - `src/pet.rs`: 定义宠物结构体和其行为。
  - `src/ui.rs`: 负责 TUI 的渲染和布局。
  - `src/state.rs`: 负责状态的加载和保存。

## 6. 约束、假设与风险

- **约束**:
  - 必须是一个纯粹的命令行应用。
  - 资源占用必须保持在极低水平。
- **假设**:
  - 用户对命令行有基本了解。
  - 用户使用的终端支持 TUI 应用所需的颜色和字符。
- **风险**:
  - **跨平台 TUI 渲染问题**: 不同终端对 TUI 的支持程度不一，可能导致显示异常。 (缓解：优先在主流终端上测试)
  - **用户兴趣下降**: 用户可能在短暂的新鲜感过后就不再使用。 (缓解：通过有趣的彩蛋和成长机制提升长期吸引力)
  - **作业控制兼容性**: 不同系统和终端对 Ctrl+Z 的支持可能有差异。 (缓解：提供清晰的文档说明)

## 7. 上线与发布计划

### 7.1. 里程碑

- **Phase 1 (MVP) - 2 周**:
  - 完成核心数据结构定义。
  - 实现基本 UI 布局和状态显示。
  - 实现喂食、洗澡、玩耍功能。
  - 完成状态的本地 JSON 持久化。
- **Phase 2 (Beta) - 1 周**:
  - 实现宠物的成长/变化逻辑。
  - 增加"遗弃"彩蛋功能。
  - 在 GitHub 发布 v0.1.0 Beta 版本，收集早期用户反馈。
- **Phase 3 (Release) - 1 周**:
  - 根据反馈修复 Bug，优化性能。
  - 完善帮助文档和 README。
  - 发布 v1.0.0 正式版。
  - 在 Homebrew, Cargo 等包管理器上发布。

## 8. 待优化功能

### 8.1. 程序退出逻辑优化

当前程序在某些情况下可能存在退出问题，需要优化：

- 确保 Ctrl+C 和 'q' 键都能正常退出程序
- 确保退出时状态能正确保存
- 提供更清晰的退出提示

### 8.2. 年龄增长机制优化

已完成以下优化：

- 年龄增长符合预期（每 5 分钟增长 1 岁）
- 年龄增长对宠物外观产生可见影响：
  - 幼年宠物（0-20 岁）：显示为年轻外观
  - 成年宠物（21-50 岁）：显示为成熟外观
  - 老年宠物（50 岁以上）：显示为老年外观
- 年龄增长对宠物行为产生可见影响：
  - 老年宠物健康下降更快
  - 老年宠物从互动中获得的益处减少，甚至可能有负面影响
  - 老年宠物睡眠时恢复效果降低

### 8.3. 健康值影响机制

已完成以下优化：

- 完善了饥饿度、清洁度、心情对健康值的具体影响规则：
  - 饥饿度 > 90：健康值每 3 秒下降 3 点
  - 饥饿度 > 80：健康值每 3 秒下降 2 点
  - 饥饿度 > 70：健康值每 3 秒下降 1 点
  - 清洁度 < 10：健康值每 3 秒下降 3 点
  - 清洁度 < 20：健康值每 3 秒下降 2 点
  - 清洁度 < 30：健康值每 3 秒下降 1 点
  - 心情 < 10：健康值每 3 秒下降 3 点
  - 心情 < 20：健康值每 3 秒下降 2 点
  - 心情 < 30：健康值每 3 秒下降 1 点
- 实现了健康值过低时的后果：
  - 健康值 < 20：宠物进入生病状态，显示生病的外观
  - 健康值 = 0：宠物死亡，显示死亡信息

### 8.4. 后台挂起时的时间计算

已完成以下优化：

- 确保在挂起期间时间计算准确：程序现在会在恢复时计算挂起期间经过的时间，并相应地更新宠物状态
- 恢复时正确显示挂起期间的状态变化：所有状态变化（饥饿、清洁度、心情、健康、年龄等）都会在恢复时正确计算和显示
- 处理长时间挂起的情况：程序能够处理任意长度的挂起时间，包括可能导致宠物死亡或生病的长时间挂起

### 8.5. 用户体验优化

已完成以下优化：

- 修复了宠物死亡后无法重新开始的问题
- 当宠物死亡时，程序现在会正确删除状态文件，允许用户下次启动时开始新的游戏

可以考虑增加以下功能：

- 帮助信息显示（通过 '?' 键等）
- 更丰富的宠物状态显示
- 更多的互动选项
- 宠物死亡或离家出走后的处理机制
